<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#1a1a2e">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<title>Zippy Voice</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #1a1a2e; color: #e0e0e0; height: 100vh;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  overflow: hidden; -webkit-user-select: none; user-select: none;
}
.top-btn {
  position: fixed; top: 16px; width: 44px; height: 44px;
  background: rgba(255,255,255,0.1); border: none; border-radius: 50%;
  color: #aaa; font-size: 20px; cursor: pointer; z-index: 100;
  display: flex; align-items: center; justify-content: center;
}
#reset-btn { left: 16px; }
#settings-btn { right: 16px; }
#new-session-btn {
  position: fixed; top: 14px; left: 50%; transform: translateX(-50%);
  background: #7c3aed; border: none; border-radius: 20px;
  color: #fff; font-size: 14px; font-weight: 600; padding: 8px 20px;
  cursor: pointer; z-index: 100; letter-spacing: 0.3px;
  transition: background 0.2s, transform 0.1s;
}
#new-session-btn:active { transform: translateX(-50%) scale(0.95); }
#new-session-btn:hover { background: #6d28d9; }
#new-session-btn.sending { background: #555; pointer-events: none; }
#mic-btn {
  width: 180px; height: 180px; border-radius: 50%; border: none; cursor: pointer;
  transition: background 0.3s, box-shadow 0.3s, transform 0.1s;
  display: flex; align-items: center; justify-content: center;
  -webkit-tap-highlight-color: transparent;
}
#mic-btn svg { width: 72px; height: 72px; fill: #fff; }
#mic-btn.idle { background: #2563eb; }
#mic-btn.recording { background: #16a34a; animation: pulse-green 1s infinite; transform: scale(1.05); }
#mic-btn.sending { background: #d97706; }
#mic-btn.playing { background: #dc2626; animation: pulse-red 1.5s infinite; }
@keyframes pulse-red {
  0% { box-shadow: 0 0 0 0 rgba(220,38,38,0.6); }
  70% { box-shadow: 0 0 0 35px rgba(220,38,38,0); }
  100% { box-shadow: 0 0 0 0 rgba(220,38,38,0); }
}
@keyframes pulse-green {
  0% { box-shadow: 0 0 0 0 rgba(22,163,74,0.5); }
  70% { box-shadow: 0 0 0 25px rgba(22,163,74,0); }
  100% { box-shadow: 0 0 0 0 rgba(22,163,74,0); }
}
#status { margin-top: 32px; font-size: 18px; color: #999; text-align: center; min-height: 28px; }
#transcript {
  margin-top: 16px; font-size: 14px; color: #666; text-align: center;
  max-width: 85%; min-height: 20px; word-wrap: break-word;
  max-height: 30vh; overflow-y: auto;
}
#timer { margin-top: 8px; font-size: 24px; color: #dc2626; font-variant-numeric: tabular-nums; min-height: 30px; }
/* Audio element hidden */
#tts-audio { display: none; }
/* Debug panel */
#debug {
  position: fixed; bottom: 0; left: 0; right: 0;
  max-height: 30vh; overflow-y: auto; background: rgba(0,0,0,0.85);
  font-family: monospace; font-size: 11px; color: #0f0; padding: 8px 12px;
  display: none; z-index: 50;
}
#debug.open { display: block; }
#debug-toggle {
  position: fixed; bottom: 8px; right: 8px; width: 36px; height: 36px;
  background: rgba(255,255,255,0.1); border: none; border-radius: 50%;
  color: #666; font-size: 14px; cursor: pointer; z-index: 100;
}
/* Settings modal */
#settings-modal {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8);
  z-index: 200; align-items: center; justify-content: center;
}
#settings-modal.open { display: flex; }
#settings-panel {
  background: #16213e; border-radius: 16px; padding: 28px;
  width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto;
}
#settings-panel h2 { color: #fff; margin-bottom: 20px; }
#settings-panel label { display: block; color: #aaa; font-size: 13px; margin-top: 14px; margin-bottom: 4px; }
#settings-panel input, #settings-panel select {
  width: 100%; padding: 10px; border: 1px solid #333;
  border-radius: 8px; background: #0f3460; color: #fff; font-size: 15px;
}
.voice-preview { display: inline-block; margin-left: 8px; font-size: 12px; color: #7c3aed; cursor: pointer; }
.btn-row { margin-top: 24px; display: flex; gap: 12px; }
.btn-row button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; }
#save-btn { background: #2563eb; color: #fff; }
#cancel-btn { background: #444; color: #fff; }
</style>
</head>
<body>
<button id="reset-btn" class="top-btn">üîÑ</button>
<button id="new-session-btn">‚ú® New Session</button>
<button id="settings-btn" class="top-btn">‚öôÔ∏è</button>

<button id="mic-btn" class="idle">
  <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
</button>

<div id="status">Tap to talk</div>
<div id="timer"></div>
<div id="transcript"></div>

<audio id="tts-audio" preload="none"></audio>

<div id="debug"></div>
<button id="debug-toggle">üêõ</button>

<div id="settings-modal">
  <div id="settings-panel">
    <h2>‚ö° Settings</h2>
    <label for="cfg-url">Server URL (blank = same origin)</label>
    <input id="cfg-url" type="url" placeholder="Leave blank for default">
    <label for="cfg-token">Auth Token</label>
    <input id="cfg-token" type="password" placeholder="Gateway token">
    <label for="cfg-voice">Voice</label>
    <select id="cfg-voice">
      <option value="en-US-AnaNeural">Ana (Young, Cheerful) ‚ú®</option>
      <option value="en-US-GuyNeural">Guy (Male, Passionate)</option>
      <option value="en-US-JennyNeural">Jenny (Female, Friendly)</option>
      <option value="en-US-AriaNeural">Aria (Female, Confident)</option>
      <option value="en-US-BrianNeural">Brian (Male, Casual)</option>
      <option value="en-US-EmmaNeural">Emma (Female, Clear)</option>
      <option value="en-US-ChristopherNeural">Christopher (Male, Authority)</option>
      <option value="en-US-AvaNeural">Ava (Female, Expressive)</option>
      <option value="en-US-AndrewNeural">Andrew (Male, Warm)</option>
      <option value="en-US-RogerNeural">Roger (Male, Lively)</option>
    </select>
    <div class="btn-row">
      <button id="cancel-btn">Cancel</button>
      <button id="save-btn">Save</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEFAULTS = { url: '', token: '', voice: 'en-US-AnaNeural' };
function loadConfig() {
  try { return { ...DEFAULTS, ...JSON.parse(localStorage.getItem('zv_config')) }; }
  catch { return { ...DEFAULTS }; }
}
function saveConfig(cfg) { localStorage.setItem('zv_config', JSON.stringify(cfg)); }
let config = loadConfig();

// ‚îÄ‚îÄ‚îÄ Debug ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const debugEl = document.getElementById('debug');
const debugToggle = document.getElementById('debug-toggle');
debugToggle.addEventListener('click', () => debugEl.classList.toggle('open'));
function dbg(msg) {
  const ts = new Date().toLocaleTimeString();
  const line = document.createElement('div');
  line.textContent = `[${ts}] ${msg}`;
  debugEl.appendChild(line);
  debugEl.scrollTop = debugEl.scrollHeight;
  console.log(`[dbg] ${msg}`);
}

// ‚îÄ‚îÄ‚îÄ DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const micBtn = document.getElementById('mic-btn');
const statusEl = document.getElementById('status');
const timerEl = document.getElementById('timer');
const transcriptEl = document.getElementById('transcript');
const audioEl = document.getElementById('tts-audio');
let sendGeneration = 0; // incremented on each new send to abort stale playback

// ‚îÄ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('settings-btn').addEventListener('click', () => {
  document.getElementById('cfg-url').value = config.url;
  document.getElementById('cfg-token').value = config.token;
  document.getElementById('cfg-voice').value = config.voice || DEFAULTS.voice;
  document.getElementById('settings-modal').classList.add('open');
});
document.getElementById('cancel-btn').addEventListener('click', () => {
  document.getElementById('settings-modal').classList.remove('open');
});
document.getElementById('save-btn').addEventListener('click', () => {
  config.url = document.getElementById('cfg-url').value.replace(/\/+$/, '') || '';
  config.token = document.getElementById('cfg-token').value;
  config.voice = document.getElementById('cfg-voice').value;
  saveConfig(config);
  document.getElementById('settings-modal').classList.remove('open');
  dbg(`Config saved. Voice: ${config.voice}`);
});

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state = 'idle'; // idle | recording | sending | playing
let mediaRecorder = null;
let audioChunks = [];
let recordingStart = 0;
let timerInterval = null;
let wakeLock = null;

function setState(newState, msg) {
  state = newState;
  micBtn.className = newState;
  statusEl.textContent = msg || {
    idle: 'Tap to talk',
    recording: 'Recording ‚Äî tap to send',
    sending: 'Sending to Zippy...',
    playing: 'Playing ‚Äî tap to stop'
  }[newState];
  if (newState !== 'recording') {
    timerEl.textContent = '';
    clearInterval(timerInterval);
  }
}

// ‚îÄ‚îÄ‚îÄ Wake Lock ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function requestWakeLock() {
  try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch {}
}

// ‚îÄ‚îÄ‚îÄ Recording ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioChunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
    mediaRecorder.ondataavailable = (e) => {
      if (e.data.size > 0) audioChunks.push(e.data);
    };
    mediaRecorder.onstop = () => stream.getTracks().forEach(t => t.stop());
    mediaRecorder.start(100);
    recordingStart = Date.now();
    setState('recording');
    requestWakeLock();
    timerInterval = setInterval(() => {
      const secs = Math.floor((Date.now() - recordingStart) / 1000);
      timerEl.textContent = `${Math.floor(secs / 60)}:${(secs % 60).toString().padStart(2, '0')}`;
    }, 200);
  } catch (e) {
    setState('idle', 'Mic permission denied');
  }
}

async function stopAndSend() {
  if (!mediaRecorder || mediaRecorder.state !== 'recording') return;
  clearInterval(timerInterval);
  return new Promise((resolve) => {
    mediaRecorder.onstop = () => {
      mediaRecorder.stream.getTracks().forEach(t => t.stop());
      resolve();
    };
    mediaRecorder.stop();
  }).then(sendAudio);
}

async function sendAudio() {
  const blob = new Blob(audioChunks, { type: 'audio/webm' });
  audioChunks = [];
  if (blob.size < 1000) { setState('idle', 'Too short ‚Äî tap and talk'); return; }

  setState('sending');
  transcriptEl.textContent = '';
  dbg(`Audio: ${blob.size} bytes`);

  // Track this send ‚Äî if interrupted, stale sends won't overwrite state
  const thisGeneration = ++sendGeneration;

  // Unlock audio on user gesture (before async work)
  audioEl.src = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYYoRwMHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=';
  audioEl.volume = 1.0;
  try { await audioEl.play(); } catch(e) { dbg('Audio unlock: ' + e.message); }
  audioEl.pause();
  audioEl.currentTime = 0;

  // Status updates while waiting
  const statusUpdates = [
    { delay: 2000, msg: 'Transcribing...' },
    { delay: 6000, msg: 'Waiting for Zippy...' },
    { delay: 15000, msg: 'Still thinking...' },
    { delay: 30000, msg: 'Almost there...' },
    { delay: 60000, msg: 'Taking a while...' }
  ];
  const timers = statusUpdates.map(u =>
    setTimeout(() => { if (state === 'sending') setState('sending', u.msg); }, u.delay)
  );

  try {
    const formData = new FormData();
    formData.append('audio', blob, 'voice.webm');
    formData.append('token', config.token);
    formData.append('voice', config.voice || 'en-US-AnaNeural');

    const baseUrl = config.url || window.location.origin;
    dbg(`POST ${baseUrl}/api/voice-send`);

    let resp, data;
    const MAX_RETRIES = 3;
    for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
      try {
        resp = await fetch(`${baseUrl}/api/voice-send`, { method: 'POST', body: formData });
        dbg(`Response: ${resp.status} (attempt ${attempt})`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        data = await resp.json();
        break; // success
      } catch (retryErr) {
        if (attempt === MAX_RETRIES) {
          timers.forEach(t => clearTimeout(t));
          throw retryErr;
        }
        dbg(`Attempt ${attempt} failed: ${retryErr.message}, retrying in 2s...`);
        await new Promise(r => setTimeout(r, 2000));
      }
    }
    timers.forEach(t => clearTimeout(t));

    if (data.error) { setState('idle', data.error); return; }

    // Abort if a newer send has started (user interrupted)
    if (thisGeneration !== sendGeneration) { dbg('Stale send, aborting'); return; }

    // Show transcript
    transcriptEl.textContent = data.fullReply
      ? data.fullReply.substring(0, 500) + (data.fullReply.length > 500 ? '...' : '')
      : data.reply || '';

    // Play server-generated audio
    if (data.audioUrl) {
      if (thisGeneration !== sendGeneration) { dbg('Stale send, skipping audio'); return; }
      dbg(`Playing audio: ${data.audioUrl}`);
      const audioSrc = (config.url || window.location.origin) + data.audioUrl;
      audioEl.src = audioSrc;
      audioEl.load();
      setState('playing');
      
      try {
        await audioEl.play();
        await new Promise((resolve) => {
          audioEl.onended = resolve;
          audioEl.onerror = resolve;
        });
      } catch (e) {
        dbg(`Audio play error: ${e.message}`);
      }
      // Only set idle if this is still the active generation
      if (thisGeneration === sendGeneration) setState('idle');
    } else {
      if (thisGeneration !== sendGeneration) return;
      dbg('No audio URL ‚Äî falling back to browser TTS');
      setState('playing');
      await browserTTS(data.reply || 'No response');
      if (thisGeneration === sendGeneration) setState('idle');
    }
  } catch (err) {
    timers.forEach(t => clearTimeout(t));
    dbg(`Error: ${err.message}`);
    setState('idle', 'Connection failed ‚Äî check settings');
  }
}

// ‚îÄ‚îÄ‚îÄ Fallback browser TTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function browserTTS(text) {
  return new Promise((resolve) => {
    if (!window.speechSynthesis) { resolve(); return; }
    speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.onend = resolve;
    utterance.onerror = resolve;
    speechSynthesis.speak(utterance);
  });
}

// ‚îÄ‚îÄ‚îÄ Stop audio playback ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function stopPlayback() {
  sendGeneration++; // invalidate any in-flight send
  audioEl.pause();
  audioEl.currentTime = 0;
  audioEl.src = ''; // clear source to prevent replay
  speechSynthesis?.cancel();
  setState('idle');
}

// ‚îÄ‚îÄ‚îÄ Main Button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
micBtn.addEventListener('click', () => {
  if (state === 'idle') {
    if (!config.token) { document.getElementById('settings-btn').click(); return; }
    startRecording();
  } else if (state === 'recording') {
    stopAndSend();
  } else if (state === 'playing') {
    stopPlayback();
  }
});

// Tap anywhere to stop playback
document.addEventListener('touchstart', (e) => {
  if (state === 'playing' && !e.target.closest('#settings-modal') && !e.target.classList.contains('top-btn') && e.target.id !== 'new-session-btn') {
    e.preventDefault();
    stopPlayback();
  }
}, { passive: false });

// ‚îÄ‚îÄ‚îÄ New Session ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('new-session-btn').addEventListener('click', async () => {
  const btn = document.getElementById('new-session-btn');
  if (btn.classList.contains('sending')) return;
  btn.classList.add('sending');
  btn.textContent = '‚è≥ Starting...';
  try {
    const baseUrl = config.url || window.location.origin;
    const resp = await fetch(`${baseUrl}/api/new-session`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: config.token })
    });
    if (resp.ok) {
      btn.textContent = '‚úÖ Fresh start!';
      transcriptEl.textContent = '';
    } else throw new Error(`HTTP ${resp.status}`);
  } catch (e) {
    btn.textContent = '‚ùå Failed';
  }
  setTimeout(() => { btn.textContent = '‚ú® New Session'; btn.classList.remove('sending'); }, 2000);
});

// ‚îÄ‚îÄ‚îÄ Hard Reset ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('reset-btn').addEventListener('click', async () => {
  if (!confirm('Reset app?')) return;
  const regs = await navigator.serviceWorker?.getRegistrations() || [];
  for (const r of regs) await r.unregister();
  const keys = await caches?.keys() || [];
  for (const k of keys) await caches.delete(k);
  window.location.reload(true);
});

// ‚îÄ‚îÄ‚îÄ Service Worker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(() => {});
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && state !== 'idle') requestWakeLock();
});
</script>
</body>
</html>
